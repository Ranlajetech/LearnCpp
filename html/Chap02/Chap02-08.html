<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>
        2.8 -- 有多个代码文件的程序
    </title>

    <link rel="stylesheet" href="../../css/main.css"/>
    <link rel="stylesheet" href="../../css/highlightjs.css">
    <link rel="stylesheet" href="../../css/linenumbercool.css"/>
    <script src="../../script/highlight.js"></script>
    <script src="../../script/highlight-cpp.js"></script>
    <script src="../../script/highlightjs-line-numbers.js"></script>
    <script>hljs.highlightAll();</script>
    <script>hljs.initLineNumbersOnLoad({singleLine: true});</script>
</head>

<body>
<h1>
    2.8 -- 有多个代码文件的程序
</h1>
<h2>
    向项目中添加文件
</h2>
<p>
    当程序越来越大时，经常会拆分成多个文件，以提高组织性并易于复用。使用 IDE 的一大优势就是它更方便处理多个文件。我们已经学过如何创建并编译单文件项目。而向已有项目添加新文件非常容易。
</p>
<div class="learncpp-blocktext-green">
    <p class="learncpp-block-title">
        最佳实践
    </p>
    <p>
        当向项目里添加新代码文件时，给它们加上 <em>.cpp</em> 拓展名。
    </p>
</div>
<div class="learncpp-blocktext-yellow">
    <p class="learncpp-block-head-content">
        Visual Studio 用户
    </p>
    <p>
        在 Visual Studio 中，右击 <em>Solution Explorer</em> 窗口的 <em>Source File</em> 文件夹（或者项目名），选择 <em>Add -- New Item...</em>。
    </p>
    <!-- picture here -->
    <p>
        确保选择了 <em>C++ File (.cpp)</em>。给新文件取个名字，然后加入项目。
    </p>
    <p>
        注意：Visual Studio 可能会显示紧凑视图而不是上面图中的完整视图。你可以继续使用紧凑视图，或者点击 <em>Show all Templates</em> 切换到完整视图。
    </p>
    <!-- picture here -->
    <p>
        注意：如果是在 <em>File</em> 菜单中而不是在 <em>Solution Explorer</em> 添加文件，新文件不会自动加到项目里，需要手动加入。右击 <em>Solution Explorer</em> 中的 <em>Source Files</em>，选择 <em>Add -- Existing Item</em>，再选择自己的文件。
    </p>
    <p>
        编译文件时，应当能看到编译器列出的文件名。
    </p>
</div>
<div class="learncpp-blocktext-yellow">
    <p class="learncpp-block-head-content">
        Code::Blocks 用户
    </p>
    <p>
        在 Code::Blocks 中，<em>File -- New -- File...</em>。
    </p>
    <!-- picture here -->
    <p>
        在 <em>New from template</em> 对话框里，选择 <em>C/C++ source</em>，点击 <em>Go</em>。
    </p>
    <!-- picture here -->
    <p>
        你可能会看到一个 <em>C/C++ source</em> 对话框的欢迎页面。如果有，点击 <em>Next</em>。
    </p>
    <!-- picture here -->
    <p>
        在下一页里，选择 <em>C++</em>，点击 <em>Next</em>。
    </p>
    <!-- picture here -->
    <p>
        给新文件取个名字（别忘了 <em>.cpp</em> 拓展名），点击 <em>All</em> 按钮保证所有生成目标都被选择了。最后点击 <em>Finish</em>。
    </p>
    <!-- picture here -->
    <p>
        编译文件时，应当能看到编译器列出的文件名。
    </p>
</div>
<div class="learncpp-blocktext-yellow">
    <p class="learncpp-block-head-content">
        GCC/G++ 用户
    </p>
    <p>
        在命令行，可以添加新文件，使用喜欢的编辑器，给它命名。编译程序时，要在编译命令里包含所有相关的代码文件。例如：<code class="inline">g++ main.cpp add.cpp -o main</code>，这里 <em>main.cpp</em> 与 <em>add.cpp</em> 是代码文件名，<em>main</em> 是输出文件名。
    </p>
</div>
<div class="learncpp-blocktext-yellow">
    <p class="learncpp-block-head-content">
        VS Code 用户
    </p>
    <p>
        在 <em>View -- Explorer</em> 打开 <em>Explorer</em> 窗口，点击项目名右侧的 <em>New File</em> 按钮。或者在 <em>File -- New File</em>。然后给文件命名（别忘了 <em>.cpp</em> 拓展名）。如果文件出现在了 <em>.vscode</em> 文件夹，把它拖到项目文件夹的一级目录。
    </p>
    <p>
        然后打开 <em>task.json</em> 文件，找到 <code class="inline">&quot;${file}&quot;,</code>。
    </p>
    <p>
        你有两个选择：
    </p>
    <ul>
        <li>如果你想明确哪些文件要编译，那就替换掉 <code class="inline">&quot;${file}&quot;,</code>，写上想要编译的每个文件名，一个一行，就像：<br/>
            <code class="inline">&quot;main.cpp&quot;,</code><br/>
            <code class="inline">&quot;add.cpp&quot;,</code><br/></li>
        <li>读者报告称，在 Windows 系统上，把 <code class="inline">&quot;${file}&quot;,</code> 替换为 <code class="inline">&quot;${fileDirname}\\**.cpp&quot;</code>，VS Code 会自动编译文件夹里所有的 <em>.cpp</em> 文件。</li>
        <li>读者报告称，在 Linux 系统上，<code class="inline">&quot;${fileDirname}/**.cpp&quot;</code> 能正常工作。</li>
    </ul>
</div>
<h2>
    多个文件的例子
</h2>
<p>
    在 <a href="Chap02-07.html" target="_blank">2.7 -- 前向声明与定义</a> 一课中，我们看过这个不能编译的单文件程序：
</p>
<pre><code class="language-cpp">#include &lt;iostream&gt;

int main()
{
    std::cout &lt;&lt; &quot;The sum of 3 and 4 is: &quot; &lt;&lt; add(3, 4) &lt;&lt; &apos;\n&apos;;
    return 0;
}

int add(int x, int y)
{
    return x + y;
}</code></pre>
<p>
    当编译器在 <code class="inline">main</code> 函数第 5 行遇到对 <code class="inline">add</code> 的调用时，它不知道 <code class="inline">add</code> 是什么，因为它直到第 9 行才被定义！解决方案是重排函数（把 <code class="inline">add</code> 放前面），或使用 <code class="inline">add</code> 的前向声明。
</p>
<p>
    然后来看这个类似的多文件程序：
</p>
<p>
    <em>add.cpp</em>：
</p>
<pre><code class="language-cpp">int add(int x, int y)
{
    return x + y;
}</code></pre>
<p>
    <em>main.cpp</em>：
</p>
<pre><code class="language-cpp">#include &lt;iostream&gt;

int main()
{
    std::cout &lt;&lt; &quot;The sum of 3 and 4 is: &quot; &lt;&lt; add(3, 4) &lt;&lt; &apos;\n&apos;; // 编译错误
    return 0;
}</code></pre>
<p>
    编译器不一定会先编译哪个文件。但无论如何，<em>main.cpp</em> 都会编译失败，给出和前一个例子相同的编译错误：
</p>
<pre><code class="language-plaintext nohljsln lighter">main.cpp(5) : error C3861: &apos;add&apos;: identifier not found</code></pre>
<p>
    原因也是相同的：编译器在 <em>main.cpp</em> 的第 5 行处不知道标识符 <code class="inline">add</code> 是什么。
</p>
<p>
    记住，编译器单独编译每个文件。它不知道别的代码文件的内容，也不记得它已经编译过的代码文件。所以即使编译器之前看过 <code class="inline">add</code> 函数的定义（如果它先编译了 <em>add.cpp</em>），它也不记得。
</p>
<p>
    这种有限可视性与短期记忆性是有意为之，由于以下原因：
</p>
<ol>
    <li>使项目中的代码文件可以以任意顺序编译。</li>
    <li>更改了代码文件时，只有这个文件需要被重新编译。</li>
    <li>减少了不同文件中标识符冲突的可能性。</li>
</ol>
<p>
    我们会在下一课（<a href="Chap02-09.html" target="_blank">2.9 -- 命名冲突与命名空间简介</a>）探讨名称冲突时会发生什么。
</p>
<p>
    这里的解决方法选项和之前相同：把 <code class="inline">add</code> 函数的定义放到 <code class="inline">main</code> 函数前面，或者使用前向声明。本例中，由于 <code class="inline">add</code> 函数在其他文件里，重排是不可能的。
</p>
<p>
    解决办法是使用前向声明：
</p>
<p>
    <em>main.cpp</em>（带有前向声明）：
</p>
<pre><code class="language-cpp">#include &lt;iostream&gt;

int add(int x, int y); // 需要, 这样 main.cpp 才知道 add() 是在别处定义的函数

int main()
{
    std::cout &lt;&lt; &quot;The sum of 3 and 4 is: &quot; &lt;&lt; add(3, 4) &lt;&lt; &apos;\n&apos;;
    return 0;
}</code></pre>
<p>
    <em>add.cpp</em>（保持不变）：
</p>
<pre><code class="language-cpp">int add(int x, int y)
{
    return x + y;
}</code></pre>
<p>
    现在，当编译器编译 <code class="inline">main.cpp</code> 时，它就知道 <code class="inline">add</code> 是什么了。链接器就会把 <em>main.cpp</em> 里对 <code class="inline">add</code> 函数的调用链接到 <code class="inline">add.cpp</code> 中的 <code class="inline">add</code> 函数定义上。
</p>
<p>
    用这种方法，就可以让文件能够访问别的文件中的函数。
</p>
<p>
    尝试自己编译 <em>add.cpp</em> 与带有前向声明的 <em>main.cpp</em>。如果出现了链接错误，确保你已经正确地把 <em>add.cpp</em> 加入了项目中，或放到了编译命令中。
</p>
<div class="learncpp-blocktext-violet">
    <p class="learncpp-block-head-content">
        提示
    </p>
    <p>
        由于编译器单独编译每个文件，而且会忘记之前看到过的内容，每个使用过 <code class="inline">std::cout</code> 或 <code class="inline">std::cin</code> 的文件都要加上 <code class="inline">#include &lt;iostream&gt;</code>。
    </p>
    <p>
        在上面的例子中，如果 <em>add.cpp</em> 使用过 <code class="inline">std::cout</code> 或 <code class="inline">std::cin</code>，那么它也需要加上 <code class="inline">#include &lt;iostream&gt;</code>。
    </p>
</div>
<div class="learncpp-blocktext-violet">
    <p class="learncpp-block-title">
        知识重点
    </p>
    <p>
        如果标识符在表达式中被使用，那么它必须能被链接到它的定义。
    </p>
    <ul>
        <li>如果编译器在当前被编译的文件中没有看到过这个标识符的前向声明或定义，他就会在标识符被使用的位置抛出错误。</li>
        <li>如果在同一文件中存在定义，编译器就会把使用这个标识符的位置与它的定义连接。</li>
        <li>如果定义在另一个文件中（对链接器可见），链接器会把使用这个标识符的位置与它的定义连接。</li>
        <li>如果链接器无法找到这个标识符的定义，就会抛出错误。</li>
    </ul>
</div>
<h2>
    出错了！
</h2>
<p>
    第一次处理多文件代码时，有大量的地方有可能会出错。如果你尝试编译上面的例子但出现了错误，检查以下几点：
</p>
<ol>
    <li>编译错误：<code class="inline">add</code> 在 <em>main</em> 中没有定义，那可能是忘记了在 <em>main.cpp</em> 中添加前向声明。</li>
    <li>
        链接错误：<code class="inline">add</code> 没有定义，比如：
        <pre><code class="language-plaintext nohljsln lighter">unresolved external symbol &quot;int __cdecl add(int,int)&quot; (?add@@YAHHH@Z) referenced in function _main</code></pre>
        <ol>
            <li>最可能的原因是没正确地把 <em>add.cpp</em> 添加进项目。编译时，应当能看到编译器列出了 <em>main.cpp</em> 与 <em>add.cpp</em>。如果只看见了 <em>main.cpp</em>，那么 <em>add.cpp</em> 肯定没有被编译。如果你在使用 Visual Studio 或 Code::Blocks，那么应该能在 IDE 侧边的 <em>Solution Explorer</em>/<em>Project</em> 面板中看到列出的 <em>add.cpp</em>。如果没看到，那就添加这个文件，尝试重新编译。如果你在命令行编译文件，不要忘记把两个文件都放到编译命令中。</li>
            <li>可能把 <em>add.cpp</em> 错误地添加到别的项目里了。</li>
            <li>可能此文件被设置为不要编译或链接。检查文件属性并确保该文件设置为要被编译或链接。在 Code::Blocks 中，编译和链接是不同的检查项，需要分别检查。在 Visual Studio 中，<em>exclude from build</em> 选项应被设为 <em>no</em> 或留空。</li>
        </ol>
    </li>
    <li>不要在 <em>main.cpp</em> 中添加 <code class="inline">#include &quot;add.cpp&quot;</code>。这会让预处理器把 <em>add.cpp</em> 的文件内容直接插入到 <em>main.cpp</em> 中，而不是把他们视作不同的文件。</li>
</ol>
<h2>
    小结
</h2>
<p>
    C++ 设计为每个代码文件都可以独立编译，不需要知道其他文件里有什么。因此与文件实际上的编译顺序毫无关系。
</p>
<p>
    到接触面向对象编译时会经常处理多文件情景，所以最好现在就确保理解如何添加并编译多文件项目。
</p>
<p>
    记住：创建新代码文件（<em>.cpp</em>）文件时，需要添加到项目中才能被编译。
</p>
<h2>
    <a href="https://www.learncpp.com/cpp-tutorial/programs-with-multiple-code-files/#:~:text=Quiz%20time" target="_blank">随堂小测</a>
</h2>
<hr/>
<nav>
    <a href="Chap02-09.html">[ 下一课：2.9 -- 命名冲突与命名空间简介 ]</a><br/>
    <a href="../../index.html" target="_blank">[ 目录 ]</a><br/>
    <a href="https://www.learncpp.com/cpp-tutorial/programs-with-multiple-code-files/" target="_blank">[ 原文地址 ]</a><br/>
    <a href="Chap02-07.html">[ 上一课：2.7 -- 前向声明与定义 ]</a>
</nav>
</body>
</html>